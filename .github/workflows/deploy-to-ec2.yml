name: Deploy to EC2

on:
  workflow_dispatch: 

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production 

    steps:
    - name: Prepare SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" | base64 -d > private_key.pem
        chmod 600 private_key.pem

    - name: Execute deploy script on EC2
      run: |
        ssh -o StrictHostKeyChecking=no \
            -i private_key.pem \
            $EC2_USER@$EC2_HOST \
            "bash /home/ec2-user/deploy.sh"
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          sudo yum update -y
          sudo service docker start || true

          aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com

          docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/mi-app:latest

          docker stop mi-app || true
          docker rm mi-app || true

          docker run -d --name mi-app -p 80:5000 ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/mi-app:latest